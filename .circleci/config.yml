version: 2.1

orbs:
  python: circleci/python@1.2
  gcp-gcr: circleci/gcp-gcr@0.13.0

executors:
  builder:
    docker:
      - image: cimg/python:3.7.11

workflows:
  test_build_push:
    jobs:
      - test:
          filters:
            tags:
              only: /.*/
      - hold:
          type: approval
          requires:
           - test
          filters:
            tags:
              only: /.*/
      - build-and-push:
          requires:
            - hold
          filters:
            tags:
              only: /.*/

jobs:
  test:
    docker:
      - image: cimg/python:3.7.11
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
      - image: cimg/postgres:9.6
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
        environment:
          POSTGRES_DB: evonoveit
          POSTGRES_USER: devel
          POSTGRES_PASSWORD: 123456
      - image: cimg/redis:6.2
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - python/install-packages:
          pkg-manager: poetry
      - run:
          name: Formatter check
          command: poetry run black --exclude migrations --check django-website
      - run:
          name: Linter check
          command: poetry run flake8 django-website
      - run:
          name: Migrations check
          environment:
            DJANGO_SETTINGS_MODULE: website.settings.test
          command: poetry run python django-website/manage.py makemigrations --check
      - run:
          name: Run tests
          environment:
            DJANGO_SETTINGS_MODULE: website.settings.test
          command: |
            mkdir test-results
            poetry run python runtests.py \
                --cov django-website \
                --cov-report html:htmlcov \
                --junitxml=test-results/junit.xml \
                django-website/
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: htmlcov
  build-and-push:
    executor:
      builder
    steps:
      - checkout
      - run:
          # The gcloud service key needs to be decoded
          name: GCloud service key setup
          command: |
            echo ${GCP_PROJECT_KEY} | base64 --decode --ignore-garbage > $HOME/gcloud-service-key.json
            echo 'export GCLOUD_SERVICE_KEY=$(cat $HOME/gcloud-service-key.json)' >> $BASH_ENV && source $BASH_ENV
      - setup_remote_docker:
          docker_layer_caching: true
      - gcp-gcr/gcr-auth
      - gcp-gcr/build-image:
          image: $CIRCLE_PROJECT_REPONAME
          tag: $CIRCLE_SHA1
          dockerfile: containers/Dockerfile
      - gcp-gcr/push-image:
          image: $CIRCLE_PROJECT_REPONAME
          tag: $CIRCLE_SHA1
      - when:
          condition: << pipeline.git.tag >>
          steps:
            - gcp-gcr/tag-image:
                image: $CIRCLE_PROJECT_REPONAME
                source-tag: $CIRCLE_SHA1
                target-tag: $CIRCLE_TAG
